<!doctype html>
<html class="no-js" lang="en-gb">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Socket.IO Test</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="apple-touch-icon" href="apple-touch-icon.png">
        <!-- Place favicon.ico in the root directory -->

        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/main.css">
        <script src="js/vendor/modernizr-2.8.3.min.js"></script>
        <script src="/js/pixi.js"></script>
        <script src="/socket.io/socket.io.js"></script>
		<script>
			var ClientID = 0;
			var Team;
			var socket = io();
			socket.on("connectionInfo", function(msg){
				ClientID = msg.ID;
				Team = msg.Team;
				onConnected();
			});
		</script>
    </head>
    <body>
        <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <!-- Add your site or application content here -->
        <p>Hello world! This is HTML5 Boilerplate.</p>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.11.3.min.js"><\/script>')</script>
        <script type="text/javascript" charset="utf-8" async defer>

        	function onConnected(){
	        	var FORWARD = 1.57079633;
	        	var BACKWARD = -FORWARD; 

	        	var players = {};
	        	var renderer = PIXI.autoDetectRenderer(800, 600,{backgroundColor : 0x1099bb});
				document.body.appendChild(renderer.view);

				var blueTeamScoreCount = 0;
				var redTeamScoreCount = 0;

				var blueTeamScore = new PIXI.Text("0", {font:"50px Arial", fill:"blue"});
				var redTeamScore = new PIXI.Text("0", {font:"50px Arial", fill:"red"});

				blueTeamScore.position.x = 50;
				redTeamScore.position.x = 500;


				// create the root of the scene graph
				var stage = new PIXI.Container();
				
				stage.addChild(blueTeamScore);
				stage.addChild(redTeamScore);

				var graphics = new PIXI.Graphics();

				var playerColour = Team == "Red" ? 0xFF0000 : 0x0000FF;

				graphics.lineStyle(2, playerColour, 1);
				graphics.beginFill(playerColour);
				graphics.drawRect(0, 590, 10, 10);
				graphics.endFill();

				var player = {
					ID:ClientID,
					graphics:graphics,
					pressed: {},
					LEFT:37,
					RIGHT:39,
					UP:38,
					DOWN:40,
					JUMPING:false,
					JUMPCOUNT:0,
					team:Team,
					hasFlag:false,
					isDown: function(keyCode){
						return this.pressed[keyCode];
					},
					onKeyDown: function(event){
						this.pressed[event.keyCode] = true;
					},
					onKeyUp: function(event){
						delete this.pressed[event.keyCode];
					},
					update: function(){

					}
				};

				stage.addChild(graphics);

				var RedFlag = Flag(0xFF0000, 10, 570);
				var BlueFlag = Flag(0x0000FF, 780, 570);

				stage.addChild(RedFlag.graphics);
				stage.addChild(BlueFlag.graphics);

				socket.on("flagCaptured", function(team){
					if(team == "Red"){
						//Reset Blue Flag
						BlueFlag.reset();
					}else{
						//Reset Red Flag
						RedFlag.reset();
					}
				});

				socket.on("update", function(serverUpdate){
					var score = serverUpdate[0].Score;
					blueTeamScore.text = score.blue;
					redTeamScore.text = score.red;
					for (var i = serverUpdate.length - 1; i >= 0; i--) {
						if(serverUpdate[i].ID == ClientID){
							player.graphics.position.x = serverUpdate[i].Data.position.x;
							player.graphics.position.y = -serverUpdate[i].Data.position.y;
							if(serverUpdate[i].Data.hasFlag){
									if(player.team == "Blue"){
										RedFlag.setPosition(player.graphics.position.x, player.graphics.position.y + 570);
									}else{
										BlueFlag.setPosition(player.graphics.position.x, player.graphics.position.y + 570);
									}
								}
						}else{
							if(players[serverUpdate[i].ID]){
								players[serverUpdate[i].ID].graphics.x = serverUpdate[i].Data.position.x;
								players[serverUpdate[i].ID].graphics.y = -serverUpdate[i].Data.position.y;
								if(serverUpdate[i].Data.hasFlag){
									if(players[serverUpdate[i].ID].team == "Blue"){
										RedFlag.setPosition(players[serverUpdate[i].ID].graphics.position.x, players[serverUpdate[i].ID].graphics.position.y + 570);
									}else{
										BlueFlag.setPosition(players[serverUpdate[i].ID].graphics.position.x, players[serverUpdate[i].ID].graphics.position.y + 570);
									}
								}
							}else{
								var graphics = new PIXI.Graphics();

								var playerColour = serverUpdate[i].Team == "Red" ? 0xFF0000 : 0x0000FF;

								graphics.lineStyle(2, playerColour, 1);
								graphics.beginFill(playerColour);
								graphics.drawRect(0, 590, 10, 10);
								graphics.endFill();

								graphics.position.x = serverUpdate[i].Data.position.x;
								graphics.position.y = serverUpdate[i].Data.position.y;

								players[serverUpdate[i].ID] = {
									ID:serverUpdate[i].ID,
									graphics:graphics,
									team: serverUpdate[i].Team,
									update:function(){
									}
								};

								stage.addChild(graphics);
							}
						}
					};		
				});

				socket.on("clientDisconnected", function(clientid){
					stage.removeChild(players[clientid].graphics);
					delete players[clientid];
				});

				// start animating
				animate();

				function animate() {

					requestAnimationFrame(animate);

					var update = {
						pressed: player.pressed,
						position: player.graphics.position,
						hasFlag: player.hasFlag
					}

					socket.emit("update", update);

					for (var item in players) {
						players[item].update();
					};

				    // render the root container
				    renderer.render(stage);
				}

				function Flag(colour, x, y){
					var graphics = new PIXI.Graphics();
					graphics.lineStyle(2, colour, 1);
					graphics.beginFill(colour);
					graphics.drawRect(0, 0, 15, 10);
					graphics.endFill();
					graphics.moveTo(0, 0);
					graphics.lineTo(0, 30);

					graphics.position.x = x;
					graphics.position.y = y;

					return {
						graphics:graphics,
						originalPosition:{x:x, y:y},
						captureInProgress: false,
						setPosition: function(x, y){
							graphics.position.x = x;
							graphics.position.y = y;
						},
						reset: function(){
							graphics.position.x = this.originalPosition.x;
							graphics.position.y = this.originalPosition.y;	
							this.captureInProgress = false;
						}
				};
			};

			window.addEventListener('keydown', function(event) {
				player.onKeyDown(event);
			}, false);
			window.addEventListener('keyup', function(event) {
				player.onKeyUp(event);
			}, false);
		}
        </script>
    </body>
</html>