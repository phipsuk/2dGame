<!doctype html>
<html class="no-js" lang="en-gb">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Socket.IO Test</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="apple-touch-icon" href="apple-touch-icon.png">
        <!-- Place favicon.ico in the root directory -->

        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/main.css">
        <script src="js/vendor/modernizr-2.8.3.min.js"></script>
        <script src="/js/pixi.js"></script>
        <script src="/socket.io/socket.io.js"></script>
		<script>
			var ClientID = 0;
			var Team;
			var socket = io();
			socket.on("connectionInfo", function(msg){
				ClientID = msg.ID;
				Team = msg.Team;
				onConnected();
			});
		</script>
		<<style type="text/css" media="screen">
			canvas { cursor: none; }
		</style>
    </head>
    <body>
        <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.11.3.min.js"><\/script>')</script>
        <script type="text/javascript" charset="utf-8" async defer>
        	var connected = false;
        	function onConnected(){
        		if(connected){
        			window.location.reload();
        		}
        		connected = true;
	        	var FORWARD = 1.57079633;
	        	var BACKWARD = -FORWARD; 

	        	var players = {};
	        	var renderer = PIXI.autoDetectRenderer(800, 600,{backgroundColor : 0x1099bb});
				document.body.appendChild(renderer.view);

				var blueTeamScoreCount = 0;
				var redTeamScoreCount = 0;

				var blueTeamScore = new PIXI.Text("0", {font:"50px Arial", fill:"blue"});
				var redTeamScore = new PIXI.Text("0", {font:"50px Arial", fill:"red"});

				var roundTime = new PIXI.Text("-- : --", {font:"50px Arial", fill:"black"});

				roundTime.position.x = 320;

				blueTeamScore.position.x = 50;
				redTeamScore.position.x = 700;

				// create the root of the scene graph
				var stage = new PIXI.Container();

				//Create Sky
				var skyTexture = PIXI.Texture.fromImage("/images/sky2.png");
				var sky = new PIXI.Sprite(skyTexture);

				stage.addChild(sky);

				//Create Grass
				var texture = PIXI.Texture.fromImage("/images/grass.png");
				var grass = new PIXI.TilingSprite(texture, 800, 50);
				grass.tileScale.x = 0.2;
				grass.tileScale.y = 0.2;
				grass.position.x = 0;
				grass.position.y = 570;

				stage.addChild(grass);
				
				stage.addChild(blueTeamScore);
				stage.addChild(redTeamScore);
				stage.addChild(roundTime);

				var graphics = new PIXI.Graphics();

				var playerColour = Team == "Red" ? 0xFF0000 : 0x0000FF;

				graphics.lineStyle(2, playerColour, 1);
				graphics.beginFill(playerColour);
				graphics.drawRect(0, 590, 10, 10);
				graphics.endFill();

				var player = {
					ID:ClientID,
					graphics:graphics,
					pressed: {},
					mousePressed: {},
					LEFT:65,
					RIGHT:68,
					UP:87,
					DOWN:83,
					SPACE:32,
					JUMPING:false,
					JUMPCOUNT:0,
					team:Team,
					hasFlag:false,
					isDown: function(keyCode){
						return this.pressed[keyCode];
					},
					onKeyDown: function(event){
						this.pressed[event.keyCode] = true;
					},
					onKeyUp: function(event){
						delete this.pressed[event.keyCode];
					},
					update: function(){

					},
					onMouseDown: function(event){
						var angle = Math.atan2(this.graphics.position.y - (event.layerY - 600), this.graphics.position.x - event.layerX);
						this.mousePressed[event.button] = {
							x: event.x,
							y: event.y,
							angle: angle
						};
					},
					onMouseUp: function(event){
						delete this.mousePressed[event.button];
					}
				};

				stage.addChild(graphics);

				var RedFlag = Flag("Red", 10, 570);
				var BlueFlag = Flag("Blue", 765, 570);

				stage.addChild(RedFlag.graphics);
				stage.addChild(BlueFlag.graphics);

				socket.on("flagCaptured", function(team){
					if(team == "Red"){
						//Reset Blue Flag
						BlueFlag.reset();
					}else{
						//Reset Red Flag
						RedFlag.reset();
					}
				});

				socket.on("update", function(serverUpdate){
					var score = serverUpdate[0].Score;
					blueTeamScore.text = score.blue;
					redTeamScore.text = score.red;
					roundTime.text = serverUpdate[0].TimeRemaining;
					for (var i = serverUpdate.length - 1; i >= 0; i--) {
						updateBulletPositions(serverUpdate[i].Bullets);
						if(serverUpdate[i].ID == ClientID){
							player.graphics.position.x = serverUpdate[i].Data.position.x;
							player.graphics.position.y = -serverUpdate[i].Data.position.y;
							if(serverUpdate[i].Data.hasFlag){
									if(player.team == "Blue"){
										RedFlag.setPosition(player.graphics.position.x, player.graphics.position.y + 570);
									}else{
										BlueFlag.setPosition(player.graphics.position.x, player.graphics.position.y + 570);
									}
								}
						}else{
							if(players[serverUpdate[i].ID]){
								players[serverUpdate[i].ID].graphics.x = serverUpdate[i].Data.position.x;
								players[serverUpdate[i].ID].graphics.y = -serverUpdate[i].Data.position.y;
								if(serverUpdate[i].Data.hasFlag){
									if(players[serverUpdate[i].ID].team == "Blue"){
										RedFlag.setPosition(players[serverUpdate[i].ID].graphics.position.x, players[serverUpdate[i].ID].graphics.position.y + 570);
									}else{
										BlueFlag.setPosition(players[serverUpdate[i].ID].graphics.position.x, players[serverUpdate[i].ID].graphics.position.y + 570);
									}
								}
							}else{
								var graphics = new PIXI.Graphics();

								var playerColour = serverUpdate[i].Team == "Red" ? 0xFF0000 : 0x0000FF;

								graphics.lineStyle(2, playerColour, 1);
								graphics.beginFill(playerColour);
								graphics.drawRect(0, 590, 10, 10);
								graphics.endFill();

								graphics.position.x = serverUpdate[i].Data.position.x;
								graphics.position.y = serverUpdate[i].Data.position.y;

								players[serverUpdate[i].ID] = {
									ID:serverUpdate[i].ID,
									graphics:graphics,
									team: serverUpdate[i].Team,
									update:function(){
									}
								};

								stage.addChild(graphics);
							}
						}
					};		
				});

				socket.on("roundComplete", function(data){
					var winText = new PIXI.Text("", {font:"50px Arial", fill:"black"});
					winText.position.x = 300;
					winText.position.y = 200;
					if(data == "Red"){
						winText.text = "Red Team Wins!";
					}else if(data == "Blue"){
						winText.text = "Blue Team Wins!";
					}else if(data == "Draw"){
						winText.text = "You all lose!";
					}
					stage.addChild(winText);
					setTimeout(function(){
						stage.removeChild(winText);
					}, 5000);
				})
				
				var levelEntities = {};

				socket.on("levelUpdate", function(data){
					for (var i = data.length - 1; i >= 0; i--) {
						var entity = data[i];
						if(levelEntities[entity.ID]){
							levelEntities[entity.ID].position.x = entity.position.x;
							levelEntities[entity.ID].position.y = -entity.position.y;
						}else{
							if(entity.shape == "Box"){
								if(entity.type){
									var entityGraphics = new PIXI.Graphics();
									entityGraphics.lineStyle(2, 0x080808, 1);
									entityGraphics.beginFill(0x080808);
									entityGraphics.drawRect((-entity.shapeOptions.width/2) + 5, (-entity.shapeOptions.height/2) + 595, entity.shapeOptions.width, entity.shapeOptions.height);
									entityGraphics.endFill();
									stage.addChild(entityGraphics);
									levelEntities[entity.ID] = entityGraphics;
									levelEntities[entity.ID].position.x = entity.position.x;
									levelEntities[entity.ID].position.y = -entity.position.y;
								}else{
									var texture = PIXI.Texture.fromImage("/images/" + entity.type + ".png");
									var entitySprite = new PIXI.TilingSprite(texture, entity.shapeOptions.width, entity.shapeOptions.height);
									entitySprite.position.x = entity.position.x;
									entitySprite.position.y = -entity.position.y;
									stage.addChild(entitySprite);
									levelEntities[entity.ID] = entitySprite;
								}
							}
						}
					};
				});

				var bulletList = {};

				var updateBulletPositions = function(bullets){
					if(bullets.length > 0){
						for (var i = bullets.length - 1; i >= 0; i--) {
							if(bulletList[bullets[i].id]){
								bulletList[bullets[i].id].position.x = bullets[i].x;
								bulletList[bullets[i].id].position.y = -bullets[i].y;	
							}else{
								var bulletGraphics = new PIXI.Graphics();
								bulletGraphics.lineStyle(2, 0x080808, 1);
								bulletGraphics.beginFill(0x080808);
								bulletGraphics.drawRect(0, 590, 2, 2);
								bulletGraphics.endFill();
								stage.addChild(bulletGraphics);
								bulletList[bullets[i].id] = bulletGraphics;
								bulletList[bullets[i].id].position.x = bullets[i].x;
								bulletList[bullets[i].id].position.y = -bullets[i].y;
							}
						};
					}
				};

				socket.on("clientDisconnected", function(clientid){
					stage.removeChild(players[clientid].graphics);
					if(players[clientid].hasFlag){
						if(players[clientid].team == "Blue"){
							BlueFlag.reset();
						}else{
							RedFlag.reset();
						}
					}
					delete players[clientid];
				});

				socket.on("bulletRemoved", function(id){
					stage.removeChild(bulletList[id]);
					delete bulletList[id];
				});

				createCrossHair();

				// start animating
				animate();

				function animate() {

					requestAnimationFrame(animate);

					var update = {
						pressed: player.pressed,
						mousePressed: player.mousePressed,
						position: player.graphics.position,
						hasFlag: player.hasFlag
					}

					socket.emit("update", update);

					for (var item in players) {
						players[item].update();
					};

				    // render the root container
				    renderer.render(stage);
				}

				function createCrossHair(){
					var graphics = new PIXI.Graphics();
					graphics.lineStyle(2, 0x080808, 1);
					graphics.beginFill(0x080808);
					graphics.drawRect(-8, 0, 5, 0.3);
					graphics.drawRect(8, 0, 5, 0.3);
					graphics.drawRect(2, -8, 0.5, 5);
					graphics.drawRect(2, 4, 0.5, 5);
					graphics.endFill();
					stage.addChild(graphics);

					var crossHair = {
						update: function(x, y){
							graphics.position.x = x;
							graphics.position.y = y;
							$("canvas").css("cursor", "none");
						}
					};

					window.addEventListener('mousemove', function(event) {
						crossHair.update(event.layerX, event.layerY);
					}, false);

					return crossHair;
				}

				function Flag(colour, x, y){
					var sprite = new PIXI.Sprite.fromImage("/images/flag_" + colour + ".png");

					sprite.position.x = x;
					sprite.position.y = y;
					sprite.scale.x = 0.1;
					sprite.scale.y = 0.1;

					return {
						graphics:sprite,
						originalPosition:{x:x, y:y},
						captureInProgress: false,
						setPosition: function(x, y){
							sprite.position.x = x;
							sprite.position.y = y;
						},
						reset: function(){
							sprite.position.x = this.originalPosition.x;
							sprite.position.y = this.originalPosition.y;	
							this.captureInProgress = false;
						}
				};
			};

			window.addEventListener('keydown', function(event) {
				player.onKeyDown(event);
			}, false);
			window.addEventListener('keyup', function(event) {
				player.onKeyUp(event);
			}, false);
			window.addEventListener('mousedown', function(event){
				player.onMouseDown(event);
			}, false);
			window.addEventListener('mouseup', function(event){
				player.onMouseUp(event);
			}, false);
		}
        </script>
    </body>
</html>