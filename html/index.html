<!doctype html>
<html class="no-js" lang="en-gb">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Socket.IO Test</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="apple-touch-icon" href="apple-touch-icon.png">
        <!-- Place favicon.ico in the root directory -->

        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/main.css">
        <script src="js/vendor/modernizr-2.8.3.min.js"></script>
        <script src="/js/pixi.js"></script>
        <script src="/js/physics.js"></script>
        <script src="/socket.io/socket.io.js"></script>
		<script>
			var ClientID = 0;
			var Team;
			var socket = io();
			socket.on("connectionInfo", function(msg){
				ClientID = msg.ID;
				Team = msg.Team;
				onConnected();
			});
		</script>
    </head>
    <body>
        <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <!-- Add your site or application content here -->
        <p>Hello world! This is HTML5 Boilerplate.</p>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.11.3.min.js"><\/script>')</script>
        <script src="js/plugins.js"></script>
        <script src="js/main.js"></script>
        <script type="text/javascript" charset="utf-8" async defer>

        	function onConnected(){
	        	var FORWARD = 1.57079633;
	        	var BACKWARD = -FORWARD; 

	        	var world = new p2.World({
					gravity:[0, -100]
				});

	            world.setGlobalStiffness(1e8);
	            world.setGlobalRelaxation(10);

	        	var players = {};
	        	var renderer = PIXI.autoDetectRenderer(800, 600,{backgroundColor : 0x1099bb});
				document.body.appendChild(renderer.view);

				var blueTeamScoreCount = 0;
				var redTeamScoreCount = 0;

				var blueTeamScore = new PIXI.Text("Blue: 0", {font:"50px Arial", fill:"blue"});
				var redTeamScore = new PIXI.Text("Red: 0", {font:"50px Arial", fill:"red"});

				blueTeamScore.position.x = 50;
				redTeamScore.position.x = 500;


				// create the root of the scene graph
				var stage = new PIXI.Container();
				
				stage.addChild(blueTeamScore);
				stage.addChild(redTeamScore);

				var graphics = new PIXI.Graphics();

				var playerColour = Team == "Red" ? 0xFF0000 : 0x0000FF;

				graphics.lineStyle(2, playerColour, 1);
				graphics.beginFill(playerColour);
				graphics.drawRect(0, 590, 10, 10);
				graphics.endFill();

				var playerBody = new p2.Body({
					mass:1,
					position: [50, 50]
				});

				var playerShape = new p2.Box({
					width:10,
					height:10
				});

				playerBody.addShape(playerShape);

				var player = {
					ID:ClientID,
					physicsBody: playerBody,
					graphics:graphics,
					pressed: {},
					LEFT:37,
					RIGHT:39,
					UP:38,
					DOWN:40,
					JUMPING:false,
					JUMPCOUNT:0,
					team:Team,
					hasFlag:false,
					isDown: function(keyCode){
						return this.pressed[keyCode];
					},
					onKeyDown: function(event){
						this.pressed[event.keyCode] = true;
					},
					onKeyUp: function(event){
						delete this.pressed[event.keyCode];
					},
					update: function(){

						if(this.isDown(this.LEFT) && this.physicsBody.position[0] > 0) this.physicsBody.velocity[0] = -100;
						if(this.isDown(this.RIGHT) &&  this.physicsBody.position[0] < 790) this.physicsBody.velocity[0] = 100;
						if(this.isDown(this.UP) && this.physicsBody.position[1] < 590){ 
							if(this.JUMPING === false && this.physicsBody.velocity[1] < 200){
								this.JUMPING = true;
								this.JUMPCOUNT++;
								this.physicsBody.velocity[1] = 100;
							}
						}else if(Math.round(this.physicsBody.velocity[1]) === 0){
							this.JUMPING = false;
							this.JUMPCOUNT = 0;
						}
						if(this.isDown(this.DOWN) && this.physicsBody.position[1] > 0) this.physicsBody.velocity[1] = -500;

						if(!this.isDown(this.LEFT) && !this.isDown(this.RIGHT)){
							this.physicsBody.velocity[0] = 0;
						}

						this.graphics.position.x = this.physicsBody.position[0];
						this.graphics.position.y = -this.physicsBody.position[1];

						if(this.hasFlag){
							if(this.team == "Blue"){
								RedFlag.setPosition(this.graphics.position.x, this.graphics.position.y + 570);
							}else{
								BlueFlag.setPosition(this.graphics.position.x, this.graphics.position.y + 570);
							}
						}
					}
				};

				world.addBody(playerBody);
				
				// Create an infinite ground plane.
				var groundBody = new p2.Body({
					mass: 0, // Setting mass to 0 makes the body static
					position: [0,0]
				});

				var groundShape = new p2.Plane();
				groundBody.addShape(groundShape);
				world.addBody(groundBody);
				var wallBody = new p2.Body({
					mass: 0, // Setting mass to 0 makes the body static
					position: [-5,0],
					angle:4.71238898
				});
				var wallShape = new p2.Plane();
				wallBody.addShape(wallShape);
				world.addBody(wallBody);
				var wallBody = new p2.Body({
					mass: 0, // Setting mass to 0 makes the body static
					position: [800,0],
					angle:1.57079633
				});
				var wallShape = new p2.Plane();
				wallBody.addShape(wallShape);
				var ceilingBody = new p2.Body({
					mass: 0, // Setting mass to 0 makes the body static
					position: [0,600],
					angle:3.14159265
				});
				var ceilingShape = new p2.Plane();
				ceilingBody.addShape(ceilingShape);
				world.addBody(ceilingBody);

				stage.addChild(graphics);

				var RedFlag = Flag(0xFF0000, 10, 570);
				var BlueFlag = Flag(0x0000FF, 780, 570);

				stage.addChild(RedFlag.graphics);
				world.addBody(RedFlag.physicsBody);
				stage.addChild(BlueFlag.graphics);
				world.addBody(BlueFlag.physicsBody);

				world.on("beginContact", function(event){
					if(player.physicsBody == event.bodyA || player.physicsBody == event.bodyB){
							//Red Flag
							if(RedFlag.physicsBody == event.bodyA || RedFlag.physicsBody == event.bodyB){
								if(player.team == "Blue"){
									player.hasFlag = true;
									RedFlag.captureInProgress = true;
								}else{
									if(player.hasFlag){
										//Flag Captured
										redTeamScoreCount++;
										redTeamScore.text = "Red: " + redTeamScoreCount;
										BlueFlag.reset();
										player.hasFlag = false;
									}
								}
							}
							//Blue Flag
							if(BlueFlag.physicsBody == event.bodyA || BlueFlag.physicsBody == event.bodyB){
								if(player.team == "Blue"){
									if(player.hasFlag){
										//Flag Captured
										blueTeamScoreCount++;
										blueTeamScore.text = "Blue: " + blueTeamScoreCount;
										RedFlag.reset();
										player.hasFlag = false;
									}
								}else{
									player.hasFlag = true;
									BlueFlag.captureInProgress = true;
								}
							}
					}
				});

				socket.on("update", function(serverUpdate){
					for (var i = serverUpdate.length - 1; i >= 0; i--) {
						if(serverUpdate[i].ID == ClientID){
							player.graphics.position.x = serverUpdate[i].Data.position.x;
							player.graphics.position.y = -serverUpdate[i].Data.position.y;
						}else{
							if(players[serverUpdate[i].ID]){
								players[serverUpdate[i].ID].physicsBody.position[0] = serverUpdate[i].Data.position.x;
								players[serverUpdate[i].ID].physicsBody.position[1] = -serverUpdate[i].Data.position.y;
								if(serverUpdate[i].Data.hasFlag){
									if(players[serverUpdate[i].ID].team == "Blue"){
										RedFlag.setPosition(players[serverUpdate[i].ID].graphics.position.x, players[serverUpdate[i].ID].graphics.position.y + 570);
									}else{
										BlueFlag.setPosition(players[serverUpdate[i].ID].graphics.position.x, players[serverUpdate[i].ID].graphics.position.y + 570);
									}
								}
							}else{
								var graphics = new PIXI.Graphics();

								var playerColour = serverUpdate[i].Team == "Red" ? 0xFF0000 : 0x0000FF;

								graphics.lineStyle(2, playerColour, 1);
								graphics.beginFill(playerColour);
								graphics.drawRect(0, 590, 10, 10);
								graphics.endFill();

								graphics.position.x = serverUpdate[i].Data.position.x;
								graphics.position.y = serverUpdate[i].Data.position.y;

								var playerBody = new p2.Body({
									mass:1,
									position: [serverUpdate[i].Data.position.x, serverUpdate[i].Data.position.y]
								});

								var playerShape = new p2.Box({
									width:10,
									height:10
								});

								playerBody.addShape(playerShape);

								players[serverUpdate[i].ID] = {
									ID:serverUpdate[i].ID,
									graphics:graphics,
									physicsBody: playerBody,
									team: serverUpdate[i].Team,
									update:function(){
										this.graphics.position.x = this.physicsBody.position[0];
										this.graphics.position.y = this.physicsBody.position[1];
									}
								};

								world.addBody(players[serverUpdate[i].ID].physicsBody);
								stage.addChild(graphics);
							}
						}
					};		
				});

				socket.on("clientDisconnected", function(clientid){
					stage.removeChild(players[clientid].graphics);
					delete players[clientid];
				});

				// start animating
				animate();

				function animate() {

					requestAnimationFrame(animate);

					var update = {
						pressed: player.pressed,
						position: player.graphics.position,
						hasFlag: player.hasFlag
					}

					socket.emit("update", update);

					//player.update();
					for (var item in players) {
						players[item].update();
					};

					//world.step(1/60);


				    // render the root container
				    renderer.render(stage);
				}

				function Flag(colour, x, y){
					var graphics = new PIXI.Graphics();
					graphics.lineStyle(2, colour, 1);
					graphics.beginFill(colour);
					graphics.drawRect(0, 0, 15, 10);
					graphics.endFill();
					graphics.moveTo(0, 0);
					graphics.lineTo(0, 30);

					graphics.position.x = x;
					graphics.position.y = y;

					var body = new p2.Body({
									mass:0,
									position: [x,0]
								});
					var bodyShape = new p2.Box({
									width:15,
									height:40,
									sensor:true
								});

					body.addShape(bodyShape);

					return {
						graphics:graphics,
						physicsBody:body,
						originalPosition:{x:x, y:y},
						captureInProgress: false,
						setPosition: function(x, y){
							graphics.position.x = x;
							graphics.position.y = y;
						},
						reset: function(){
							graphics.position.x = this.originalPosition.x;
							graphics.position.y = this.originalPosition.y;	
							this.captureInProgress = false;
						}
				};
			};

			window.addEventListener('keydown', function(event) {
				player.onKeyDown(event);
			}, false);
			window.addEventListener('keyup', function(event) {
				player.onKeyUp(event);
			}, false);
		}
        </script>
    </body>
</html>